# ============================================================================
# Bragi Fluxer Bots - Docker Compose
# ============================================================================
# FILE VERSION: v1.0.0
# Repository: https://github.com/the-alphabet-cartel/bragi
# Community: The Alphabet Cartel - https://discord.gg/alphabetcartel
# ============================================================================
name: bragi-bots

### Common Settings ###
x-common: &common
  restart: unless-stopped
  networks:
    - bragi-net

### Common Environmental Variables ###
x-env: &env
  PGID: ${PGID:-1000}
  PUID: ${PUID:-1000}
  TZ: ${TZ:-America/Los_Angeles}

### Common Healthcheck Settings ###
x-health: &health
  interval: 5s
  timeout: 10s
  retries: 3
  start_period: 60s
  start_interval: 30s

services:
  # ===========================================================================
  # Portia - Temporary Voice Channels Bot
  # ===========================================================================
  portia:
    image: ghcr.io/the-alphabet-cartel/portia:latest
    container_name: portia
    <<: *common
    environment:
      <<: *env
      TOKEN_FILE: /run/secrets/portia_token
    env_file: .env
    secrets:
      - portia_token
    volumes:
      - /opt/bragi/portia/logs:/app/logs
      - /opt/bragi/portia/data:/app/data
      - /opt/bragi/portia/config:/app/src/config
    healthcheck:
      <<: *health

  # ===========================================================================
  # Prism - Introductions Role Assignment Bot
  # ===========================================================================
  prism:
    image: ghcr.io/the-alphabet-cartel/prism:latest
    container_name: prism
    <<: *common
    environment:
      <<: *env
      TOKEN_FILE: /run/secrets/prism_token
    env_file: .env
    secrets:
      - prism_token
    volumes:
      - /opt/bragi/prism/logs:/app/logs
      - /opt/bragi/prism/data:/app/data
      - /opt/bragi/prism/config:/app/src/config
    healthcheck:
      <<: *health

  # ===========================================================================
  # Puck - Creator Go Live Bot
  # ===========================================================================
  puck:
    image: ghcr.io/the-alphabet-cartel/puck:latest
    container_name: puck-bot
    <<: *common
    environment:
      <<: *env
      TOKEN_FILE: /run/secrets/puck_token
      TWITCH_CLIENT_ID_FILE: /run/secrets/twitch_client_id
      TWITCH_CLIENT_SECRET_FILE: /run/secrets/twitch_client_secret
      YOUTUBE_API_KEY_FILE: /run/secrets/youtube_api_key
    env_file: .env
    secrets:
      - puck_token
      - twitch_client_id
      - twitch_client_secret
      - youtube_api_key
    volumes:
      - /opt/bragi/puck/logs:/app/logs
      - /opt/bragi/puck/data:/app/data
      - /opt/bragi/puck/config:/app/src/config
    healthcheck:
      <<: *health

  # ===========================================================================
  # Ratatoskr - JTFD's Task Manager
  # ===========================================================================
  ratatoskr:
    image: ghcr.io/the-alphabet-cartel/ratatoskr:latest
    container_name: ratatoskr
    <<: *common
    environment:
      <<: *env
      TOKEN_FILE: /run/secrets/ratatoskr_token
    env_file: .env
    secrets:
      - ratatoskr_token
    volumes:
      - /opt/bragi/ratatoskr/logs:/app/logs
      - /opt/bragi/ratatoskr/data:/app/data
      - /opt/bragi/ratatoskr/config:/app/src/config
    healthcheck:
      <<: *health

secrets:
  portia_token:
    file: ./secrets/portia_fluxer_token
  prism_token:
    file: ./secrets/prism_fluxer_token
  puck_token:
    file: ./secrets/puck_fluxer_token
  ratatoskr_token:
    file: ./secrets/ratatoskr_fluxer_token
  twitch_client_id:
    file: ./secrets/twitch_client_id
  twitch_client_secret:
    file: ./secrets/twitch_client_secret
  youtube_api_key:
    file: ./secrets/youtube_api_key

networks:
  bragi-net:
    driver: bridge
